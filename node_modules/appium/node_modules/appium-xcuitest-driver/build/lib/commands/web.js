"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const IPHONE_TOP_BAR_HEIGHT = 71;
const IPHONE_SCROLLED_TOP_BAR_HEIGHT = 41;
const IPHONE_X_SCROLLED_OFFSET = 55;
const IPHONE_X_NOTCH_OFFSET_IOS = 24;
const IPHONE_X_NOTCH_OFFSET_IOS_13 = 20;
const IPHONE_LANDSCAPE_TOP_BAR_HEIGHT = 51;
const IPHONE_BOTTOM_BAR_OFFSET = 49;
const TAB_BAR_OFFSET = 33;
const IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
const IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;
const NOTCHED_DEVICE_SIZES = [{
  w: 1125,
  h: 2436
}, {
  w: 828,
  h: 1792
}, {
  w: 1242,
  h: 2688
}];
const ATOM_WAIT_TIMEOUT = 2 * 60000;
const ATOM_WAIT_ALERT_WAIT = 400;
let extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.web);
extensions.getSafariIsIphone = _lodash.default.memoize(async function getSafariIsIphone() {
  try {
    const userAgent = await this.execute('return navigator.userAgent');
    return userAgent.toLowerCase().includes('iphone');
  } catch (err) {
    _logger.default.warn(`Unable to find device type from useragent. Assuming iPhone`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return true;
});
extensions.getSafariDeviceSize = _lodash.default.memoize(async function getSafariDeviceSize() {
  const script = 'return {height: window.screen.availHeight * window.devicePixelRatio, width: window.screen.availWidth * window.devicePixelRatio};';
  const {
    width,
    height
  } = await this.execute(script);
  const [normHeight, normWidth] = height > width ? [height, width] : [width, height];
  return {
    width: normWidth,
    height: normHeight
  };
});
extensions.getSafariIsNotched = _lodash.default.memoize(async function getSafariIsNotched() {
  try {
    const {
      width,
      height
    } = await this.getSafariDeviceSize();

    for (const device of NOTCHED_DEVICE_SIZES) {
      if (device.w === width && device.h === height) {
        return true;
      }
    }
  } catch (err) {
    _logger.default.warn(`Unable to find device type from dimensions. Assuming the device is not notched`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return false;
});

extensions.getExtraTranslateWebCoordsOffset = async function getExtraTranslateWebCoordsOffset(wvPos, realDims) {
  let topOffset = 0;
  let bottomOffset = 0;
  const isIphone = await this.getSafariIsIphone();
  const isNotched = isIphone && (await this.getSafariIsNotched());
  const orientation = realDims.h > realDims.w ? 'PORTRAIT' : 'LANDSCAPE';
  const notchOffset = isNotched ? _appiumSupport.util.compareVersions(this.opts.platformVersion, '=', '13.0') ? IPHONE_X_NOTCH_OFFSET_IOS_13 : IPHONE_X_NOTCH_OFFSET_IOS : 0;
  const isScrolled = await this.execute('return document.documentElement.scrollTop > 0');

  if (isScrolled) {
    topOffset = IPHONE_SCROLLED_TOP_BAR_HEIGHT + notchOffset;

    if (isNotched) {
      topOffset -= IPHONE_X_SCROLLED_OFFSET;
    }

    if (orientation === 'LANDSCAPE' && isIphone) {
      topOffset = 0;
    }
  } else {
    topOffset = IPHONE_TOP_BAR_HEIGHT + notchOffset;

    if (isIphone) {
      if (orientation === 'PORTRAIT') {
        bottomOffset = IPHONE_BOTTOM_BAR_OFFSET;
      } else {
        topOffset = IPHONE_LANDSCAPE_TOP_BAR_HEIGHT;
      }
    }

    if (orientation === 'LANDSCAPE' || !isIphone) {
      const tabs = await this.findNativeElementOrElements('-ios predicate string', `name LIKE '*, Tab' AND visible = 1`, true);

      if (tabs.length > 0) {
        topOffset += TAB_BAR_OFFSET;
      }
    }
  }

  topOffset += await this.getExtraNativeWebTapOffset();
  wvPos.y += topOffset;
  realDims.h -= topOffset + bottomOffset;
};

extensions.getExtraNativeWebTapOffset = async function getExtraNativeWebTapOffset() {
  let offset = 0;
  const banners = await this.findNativeElementOrElements('accessibility id', 'Close app download offer', true);

  if (banners.length > 0) {
    offset += (await this.getSafariIsIphone()) ? IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET : IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;
  }

  _logger.default.debug(`Additional native web tap offset computed: ${offset}`);

  return offset;
};

async function tapWebElementNatively(driver, atomsElement) {
  try {
    let text = await driver.executeAtom('get_text', [atomsElement]);

    if (!text) {
      text = await driver.executeAtom('get_attribute_value', [atomsElement, 'value']);
    }

    if (text) {
      const els = await driver.findNativeElementOrElements('accessibility id', text, true);

      if (els.length === 1 || els.length === 2) {
        const el = els[0];
        const rect = await driver.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(el)}/rect`, 'GET');

        if (els.length === 2) {
          const el2 = els[1];
          const rect2 = await driver.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(el2)}/rect`, 'GET');

          if (rect.x !== rect2.x || rect.y !== rect2.y || rect.width !== rect2.width || rect.height !== rect2.height) {
            return false;
          }
        }

        const coords = {
          x: Math.round(rect.x + rect.width / 2),
          y: Math.round(rect.y + rect.height / 2)
        };
        await driver.clickCoords(coords);
        return true;
      }
    }
  } catch (err) {
    _logger.default.warn(`Error attempting to click: ${err.message}`);
  }

  return false;
}

extensions.nativeWebTap = async function nativeWebTap(el) {
  const atomsElement = this.useAtomsElement(el);

  if (!(await this.settings.getSettings()).nativeWebTapStrict && (await tapWebElementNatively(this, atomsElement))) {
    return;
  }

  _logger.default.warn('Unable to do simple native web tap. Attempting to convert coordinates');

  await this.executeAtom('get_size', [atomsElement]);
  await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  const {
    width,
    height
  } = await this.executeAtom('get_size', [atomsElement]);
  let {
    x,
    y
  } = await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  x += width / 2;
  y += height / 2;
  this.curWebCoords = {
    x,
    y
  };
  await this.clickWebCoords();
};

extensions.clickCoords = async function clickCoords(coords) {
  await this.performTouch([{
    action: 'tap',
    options: coords
  }]);
};

extensions.translateWebCoords = async function translateWebCoords(coords) {
  _logger.default.debug(`Translating coordinates (${JSON.stringify(coords)}) to web coordinates`);

  let webview = await (0, _asyncbox.retryInterval)(5, 100, async () => {
    const webviews = await this.findNativeElementOrElements('class name', 'XCUIElementTypeWebView', true);

    if (webviews.length === 0) {
      throw new Error(`No webviews found. Unable to translate web coordinates for native web tap`);
    }

    return webviews[0];
  });
  webview = _appiumSupport.util.unwrapElement(webview);
  const rect = await this.proxyCommand(`/element/${webview}/rect`, 'GET');
  const wvPos = {
    x: rect.x,
    y: rect.y
  };
  const realDims = {
    w: rect.width,
    h: rect.height
  };
  const cmd = '(function () { return {w: window.innerWidth, h: window.innerHeight}; })()';
  const wvDims = await this.remote.execute(cmd);
  const implicitWaitMs = this.implicitWaitMs;
  await this.setImplicitWait(0);

  try {
    await this.getExtraTranslateWebCoordsOffset(wvPos, realDims);
  } finally {
    await this.setImplicitWait(implicitWaitMs);
  }

  if (wvDims && realDims && wvPos) {
    let xRatio = realDims.w / wvDims.w;
    let yRatio = realDims.h / wvDims.h;
    let newCoords = {
      x: wvPos.x + Math.round(xRatio * coords.x),
      y: wvPos.y + Math.round(yRatio * coords.y)
    };

    _logger.default.debug(`Converted coordinates: ${JSON.stringify(newCoords)}`);

    _logger.default.debug(`    rect: ${JSON.stringify(rect)}`);

    _logger.default.debug(`    wvPos: ${JSON.stringify(wvPos)}`);

    _logger.default.debug(`    realDims: ${JSON.stringify(realDims)}`);

    _logger.default.debug(`    wvDims: ${JSON.stringify(wvDims)}`);

    _logger.default.debug(`    xRatio: ${JSON.stringify(xRatio)}`);

    _logger.default.debug(`    yRatio: ${JSON.stringify(yRatio)}`);

    _logger.default.debug(`Converted web coords ${JSON.stringify(coords)} ` + `into real coords ${JSON.stringify(newCoords)}`);

    return newCoords;
  }
};

extensions.checkForAlert = async function checkForAlert() {
  return _lodash.default.isString(await this.getAlertText());
};

extensions.waitForAtom = async function waitForAtom(promise) {
  const timer = new _appiumSupport.timing.Timer().start();
  let done = false;
  let error = null;
  promise = _bluebird.default.resolve(promise).timeout(ATOM_WAIT_TIMEOUT).catch(function (err) {
    _logger.default.debug(`Error received while executing atom: ${err.message}`);

    if (err instanceof _bluebird.default.TimeoutError) {
      err = new Error(`Did not get any response for atom execution after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    }

    error = err;
  }).finally(function () {
    done = true;
  });

  for (let i = 0; i < 10; i++) {
    try {
      await (0, _asyncbox.waitForCondition)(() => done, {
        waitMs: ATOM_WAIT_ALERT_WAIT,
        intervalMs: 0
      });
      break;
    } catch (ign) {}

    try {
      const res = await _bluebird.default.any([this.checkForAlert(), promise]);

      if (error) {
        throw error;
      }

      return this.parseExecuteResponse(res);
    } catch (err) {
      _logger.default.debug(`No alert found: ${err.message}`);
    }
  }

  const res = await promise;

  if (error) {
    throw error;
  }

  return this.parseExecuteResponse(res);
};

extensions.mobileWebNav = async function mobileWebNav(navType) {
  this.remote.allowNavigationWithoutReload = true;

  try {
    await this.executeAtom('execute_script', [`history.${navType}();`, null]);
  } finally {
    this.remote.allowNavigationWithoutReload = false;
  }
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93ZWIuanMiXSwibmFtZXMiOlsiSVBIT05FX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1hfU0NST0xMRURfT0ZGU0VUIiwiSVBIT05FX1hfTk9UQ0hfT0ZGU0VUX0lPUyIsIklQSE9ORV9YX05PVENIX09GRlNFVF9JT1NfMTMiLCJJUEhPTkVfTEFORFNDQVBFX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX0JPVFRPTV9CQVJfT0ZGU0VUIiwiVEFCX0JBUl9PRkZTRVQiLCJJUEhPTkVfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUIiwiSVBBRF9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQiLCJOT1RDSEVEX0RFVklDRV9TSVpFUyIsInciLCJoIiwiQVRPTV9XQUlUX1RJTUVPVVQiLCJBVE9NX1dBSVRfQUxFUlRfV0FJVCIsImV4dGVuc2lvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJpb3NDb21tYW5kcyIsIndlYiIsImdldFNhZmFyaUlzSXBob25lIiwiXyIsIm1lbW9pemUiLCJ1c2VyQWdlbnQiLCJleGVjdXRlIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImVyciIsImxvZyIsIndhcm4iLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJnZXRTYWZhcmlEZXZpY2VTaXplIiwic2NyaXB0Iiwid2lkdGgiLCJoZWlnaHQiLCJub3JtSGVpZ2h0Iiwibm9ybVdpZHRoIiwiZ2V0U2FmYXJpSXNOb3RjaGVkIiwiZGV2aWNlIiwiZ2V0RXh0cmFUcmFuc2xhdGVXZWJDb29yZHNPZmZzZXQiLCJ3dlBvcyIsInJlYWxEaW1zIiwidG9wT2Zmc2V0IiwiYm90dG9tT2Zmc2V0IiwiaXNJcGhvbmUiLCJpc05vdGNoZWQiLCJvcmllbnRhdGlvbiIsIm5vdGNoT2Zmc2V0IiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsIm9wdHMiLCJwbGF0Zm9ybVZlcnNpb24iLCJpc1Njcm9sbGVkIiwidGFicyIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImxlbmd0aCIsImdldEV4dHJhTmF0aXZlV2ViVGFwT2Zmc2V0IiwieSIsIm9mZnNldCIsImJhbm5lcnMiLCJ0YXBXZWJFbGVtZW50TmF0aXZlbHkiLCJkcml2ZXIiLCJhdG9tc0VsZW1lbnQiLCJ0ZXh0IiwiZXhlY3V0ZUF0b20iLCJlbHMiLCJlbCIsInJlY3QiLCJwcm94eUNvbW1hbmQiLCJ1bndyYXBFbGVtZW50IiwiZWwyIiwicmVjdDIiLCJ4IiwiY29vcmRzIiwiTWF0aCIsInJvdW5kIiwiY2xpY2tDb29yZHMiLCJuYXRpdmVXZWJUYXAiLCJ1c2VBdG9tc0VsZW1lbnQiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwibmF0aXZlV2ViVGFwU3RyaWN0IiwiY3VyV2ViQ29vcmRzIiwiY2xpY2tXZWJDb29yZHMiLCJwZXJmb3JtVG91Y2giLCJhY3Rpb24iLCJvcHRpb25zIiwidHJhbnNsYXRlV2ViQ29vcmRzIiwiSlNPTiIsInN0cmluZ2lmeSIsIndlYnZpZXciLCJ3ZWJ2aWV3cyIsIkVycm9yIiwiY21kIiwid3ZEaW1zIiwicmVtb3RlIiwiaW1wbGljaXRXYWl0TXMiLCJzZXRJbXBsaWNpdFdhaXQiLCJ4UmF0aW8iLCJ5UmF0aW8iLCJuZXdDb29yZHMiLCJjaGVja0ZvckFsZXJ0IiwiaXNTdHJpbmciLCJnZXRBbGVydFRleHQiLCJ3YWl0Rm9yQXRvbSIsInByb21pc2UiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJkb25lIiwiZXJyb3IiLCJCIiwicmVzb2x2ZSIsInRpbWVvdXQiLCJjYXRjaCIsIlRpbWVvdXRFcnJvciIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwiZmluYWxseSIsImkiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiaWduIiwicmVzIiwiYW55IiwicGFyc2VFeGVjdXRlUmVzcG9uc2UiLCJtb2JpbGVXZWJOYXYiLCJuYXZUeXBlIiwiYWxsb3dOYXZpZ2F0aW9uV2l0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QixFQUE2QjtBQUNqQ1ksUUFBQUEsTUFBTSxFQUFFN0csb0JBRHlCO0FBRWpDOEcsUUFBQUEsVUFBVSxFQUFFO0FBRnFCLE9BQTdCLENBQU47QUFLQTtBQUNELEtBUEQsQ0FPRSxPQUFPQyxHQUFQLEVBQVksQ0FFYjs7QUFHRCxRQUFJO0FBQ0YsWUFBTUMsR0FBRyxHQUFHLE1BQU1iLGtCQUFFYyxHQUFGLENBQU0sQ0FBQyxLQUFLekIsYUFBTCxFQUFELEVBQXVCSSxPQUF2QixDQUFOLENBQWxCOztBQUNBLFVBQUlNLEtBQUosRUFBVztBQUNULGNBQU1BLEtBQU47QUFDRDs7QUFDRCxhQUFPLEtBQUtnQixvQkFBTCxDQUEwQkYsR0FBMUIsQ0FBUDtBQUNELEtBTkQsQ0FNRSxPQUFPbkcsR0FBUCxFQUFZO0FBRVpDLHNCQUFJRSxLQUFKLENBQVcsbUJBQWtCSCxHQUFHLENBQUNJLE9BQVEsRUFBekM7QUFDRDtBQUNGOztBQUlELFFBQU0rRixHQUFHLEdBQUcsTUFBTXBCLE9BQWxCOztBQUNBLE1BQUlNLEtBQUosRUFBVztBQUNULFVBQU1BLEtBQU47QUFDRDs7QUFDRCxTQUFPLEtBQUtnQixvQkFBTCxDQUEwQkYsR0FBMUIsQ0FBUDtBQUNELENBdkREOztBQXlEQS9HLFVBQVUsQ0FBQ2tILFlBQVgsR0FBMEIsZUFBZUEsWUFBZixDQUE2QkMsT0FBN0IsRUFBc0M7QUFDOUQsT0FBS2xDLE1BQUwsQ0FBWW1DLDRCQUFaLEdBQTJDLElBQTNDOztBQUNBLE1BQUk7QUFDRixVQUFNLEtBQUtsRSxXQUFMLENBQWlCLGdCQUFqQixFQUFtQyxDQUFFLFdBQVVpRSxPQUFRLEtBQXBCLEVBQTBCLElBQTFCLENBQW5DLENBQU47QUFDRCxHQUZELFNBRVU7QUFDUixTQUFLbEMsTUFBTCxDQUFZbUMsNEJBQVosR0FBMkMsS0FBM0M7QUFDRDtBQUNGLENBUEQ7O2VBVWVwSCxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdXRpbCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgSVBIT05FX1RPUF9CQVJfSEVJR0hUID0gNzE7XG5jb25zdCBJUEhPTkVfU0NST0xMRURfVE9QX0JBUl9IRUlHSFQgPSA0MTtcbmNvbnN0IElQSE9ORV9YX1NDUk9MTEVEX09GRlNFVCA9IDU1O1xuY29uc3QgSVBIT05FX1hfTk9UQ0hfT0ZGU0VUX0lPUyA9IDI0O1xuY29uc3QgSVBIT05FX1hfTk9UQ0hfT0ZGU0VUX0lPU18xMyA9IDIwO1xuXG5jb25zdCBJUEhPTkVfTEFORFNDQVBFX1RPUF9CQVJfSEVJR0hUID0gNTE7XG5jb25zdCBJUEhPTkVfQk9UVE9NX0JBUl9PRkZTRVQgPSA0OTtcbmNvbnN0IFRBQl9CQVJfT0ZGU0VUID0gMzM7XG5jb25zdCBJUEhPTkVfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUID0gODQ7XG5jb25zdCBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDk1O1xuXG5jb25zdCBOT1RDSEVEX0RFVklDRV9TSVpFUyA9IFtcbiAge3c6IDExMjUsIGg6IDI0MzZ9LCAvLyAxMSBQcm8sIFgsIFhzXG4gIHt3OiA4MjgsIGg6IDE3OTJ9LCAvLyAxMSwgWHJcbiAge3c6IDEyNDIsIGg6IDI2ODh9LCAvLyAxMSBQcm8gTWF4LCBYcyBNYXhcbl07XG5cbmNvbnN0IEFUT01fV0FJVF9USU1FT1VUID0gMiAqIDYwMDAwO1xuY29uc3QgQVRPTV9XQUlUX0FMRVJUX1dBSVQgPSA0MDA7XG5cbmxldCBleHRlbnNpb25zID0ge307XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMud2ViKTtcblxuXG5cbmV4dGVuc2lvbnMuZ2V0U2FmYXJpSXNJcGhvbmUgPSBfLm1lbW9pemUoYXN5bmMgZnVuY3Rpb24gZ2V0U2FmYXJpSXNJcGhvbmUgKCkge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJBZ2VudCA9IGF3YWl0IHRoaXMuZXhlY3V0ZSgncmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQnKTtcbiAgICByZXR1cm4gdXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2lwaG9uZScpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlIHR5cGUgZnJvbSB1c2VyYWdlbnQuIEFzc3VtaW5nIGlQaG9uZWApO1xuICAgIGxvZy5kZWJ1ZyhgRXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59KTtcblxuZXh0ZW5zaW9ucy5nZXRTYWZhcmlEZXZpY2VTaXplID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldFNhZmFyaURldmljZVNpemUgKCkge1xuICBjb25zdCBzY3JpcHQgPSAncmV0dXJuIHtoZWlnaHQ6IHdpbmRvdy5zY3JlZW4uYXZhaWxIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbywgd2lkdGg6IHdpbmRvdy5zY3JlZW4uYXZhaWxXaWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvfTsnO1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGUoc2NyaXB0KTtcbiAgY29uc3QgW25vcm1IZWlnaHQsIG5vcm1XaWR0aF0gPSBoZWlnaHQgPiB3aWR0aCA/IFtoZWlnaHQsIHdpZHRoXSA6IFt3aWR0aCwgaGVpZ2h0XTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aDogbm9ybVdpZHRoLFxuICAgIGhlaWdodDogbm9ybUhlaWdodCxcbiAgfTtcbn0pO1xuXG5leHRlbnNpb25zLmdldFNhZmFyaUlzTm90Y2hlZCA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiBnZXRTYWZhcmlJc05vdGNoZWQgKCkge1xuICB0cnkge1xuICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0U2FmYXJpRGV2aWNlU2l6ZSgpO1xuICAgIGZvciAoY29uc3QgZGV2aWNlIG9mIE5PVENIRURfREVWSUNFX1NJWkVTKSB7XG4gICAgICBpZiAoZGV2aWNlLncgPT09IHdpZHRoICYmIGRldmljZS5oID09PSBoZWlnaHQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlIHR5cGUgZnJvbSBkaW1lbnNpb25zLiBBc3N1bWluZyB0aGUgZGV2aWNlIGlzIG5vdCBub3RjaGVkYCk7XG4gICAgbG9nLmRlYnVnKGBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59KTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCA9IGFzeW5jIGZ1bmN0aW9uIGdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0ICh3dlBvcywgcmVhbERpbXMpIHtcbiAgbGV0IHRvcE9mZnNldCA9IDA7XG4gIGxldCBib3R0b21PZmZzZXQgPSAwO1xuXG4gIGNvbnN0IGlzSXBob25lID0gYXdhaXQgdGhpcy5nZXRTYWZhcmlJc0lwaG9uZSgpO1xuICBjb25zdCBpc05vdGNoZWQgPSBpc0lwaG9uZSAmJiBhd2FpdCB0aGlzLmdldFNhZmFyaUlzTm90Y2hlZCgpO1xuXG4gIGNvbnN0IG9yaWVudGF0aW9uID0gcmVhbERpbXMuaCA+IHJlYWxEaW1zLncgPyAnUE9SVFJBSVQnIDogJ0xBTkRTQ0FQRSc7XG5cbiAgY29uc3Qgbm90Y2hPZmZzZXQgPSBpc05vdGNoZWRcbiAgICA/IHV0aWwuY29tcGFyZVZlcnNpb25zKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24sICc9JywgJzEzLjAnKVxuICAgICAgPyBJUEhPTkVfWF9OT1RDSF9PRkZTRVRfSU9TXzEzXG4gICAgICA6IElQSE9ORV9YX05PVENIX09GRlNFVF9JT1NcbiAgICA6IDA7XG5cbiAgY29uc3QgaXNTY3JvbGxlZCA9IGF3YWl0IHRoaXMuZXhlY3V0ZSgncmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgPiAwJyk7XG4gIGlmIChpc1Njcm9sbGVkKSB7XG4gICAgdG9wT2Zmc2V0ID0gSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUICsgbm90Y2hPZmZzZXQ7XG5cbiAgICBpZiAoaXNOb3RjaGVkKSB7XG4gICAgICB0b3BPZmZzZXQgLT0gSVBIT05FX1hfU0NST0xMRURfT0ZGU0VUO1xuICAgIH1cblxuICAgIC8vIElmIHRoZSBpUGhvbmUgaXMgbGFuZHNjYXBlIHRoZW4gdGhlcmUgaXMgbm8gdG9wIGJhclxuICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ0xBTkRTQ0FQRScgJiYgaXNJcGhvbmUpIHtcbiAgICAgIHRvcE9mZnNldCA9IDA7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRvcE9mZnNldCA9IElQSE9ORV9UT1BfQkFSX0hFSUdIVCArIG5vdGNoT2Zmc2V0O1xuXG4gICAgaWYgKGlzSXBob25lKSB7XG4gICAgICBpZiAob3JpZW50YXRpb24gPT09ICdQT1JUUkFJVCcpIHtcbiAgICAgICAgLy8gVGhlIGJvdHRvbSBiYXIgaXMgb25seSB2aXNpYmxlIHdoZW4gcG9ydHJhaXRcbiAgICAgICAgYm90dG9tT2Zmc2V0ID0gSVBIT05FX0JPVFRPTV9CQVJfT0ZGU0VUO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdG9wT2Zmc2V0ID0gSVBIT05FX0xBTkRTQ0FQRV9UT1BfQkFSX0hFSUdIVDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnIHx8ICFpc0lwaG9uZSkge1xuICAgICAgLy8gVGFicyBvbmx5IGFwcGVhciBpZiB0aGUgZGV2aWNlIGlzIGxhbmRzY2FwZSBvciBpZiBpdCdzIGFuIGlQYWQgc28gd2Ugb25seSBjaGVjayB2aXNpYmlsaXR5IGluIHRoaXMgY2FzZVxuICAgICAgY29uc3QgdGFicyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCctaW9zIHByZWRpY2F0ZSBzdHJpbmcnLCBgbmFtZSBMSUtFICcqLCBUYWInIEFORCB2aXNpYmxlID0gMWAsIHRydWUpO1xuICAgICAgaWYgKHRhYnMubGVuZ3RoID4gMCkge1xuICAgICAgICB0b3BPZmZzZXQgKz0gVEFCX0JBUl9PRkZTRVQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdG9wT2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQoKTtcblxuICB3dlBvcy55ICs9IHRvcE9mZnNldDtcbiAgcmVhbERpbXMuaCAtPSAodG9wT2Zmc2V0ICsgYm90dG9tT2Zmc2V0KTtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQgPSBhc3luYyBmdW5jdGlvbiBnZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCAoKSB7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIC8vIHRyeSB0byBzZWUgaWYgdGhlcmUgaXMgYW4gU21hcnQgQXBwIEJhbm5lclxuICBjb25zdCBiYW5uZXJzID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnQ2xvc2UgYXBwIGRvd25sb2FkIG9mZmVyJywgdHJ1ZSk7XG4gIGlmIChiYW5uZXJzLmxlbmd0aCA+IDApIHtcbiAgICBvZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRTYWZhcmlJc0lwaG9uZSgpID9cbiAgICAgIElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgOlxuICAgICAgSVBBRF9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQ7XG4gIH1cblxuICBsb2cuZGVidWcoYEFkZGl0aW9uYWwgbmF0aXZlIHdlYiB0YXAgb2Zmc2V0IGNvbXB1dGVkOiAke29mZnNldH1gKTtcbiAgcmV0dXJuIG9mZnNldDtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIHRhcFdlYkVsZW1lbnROYXRpdmVseSAoZHJpdmVyLCBhdG9tc0VsZW1lbnQpIHtcbiAgLy8gdHJ5IHRvIGdldCB0aGUgdGV4dCBvZiB0aGUgZWxlbWVudCwgd2hpY2ggd2lsbCBiZSBhY2Nlc3NpYmxlIGluIHRoZVxuICAvLyBuYXRpdmUgY29udGV4dFxuICB0cnkge1xuICAgIGxldCB0ZXh0ID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVBdG9tKCdnZXRfdGV4dCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgICBpZiAoIXRleHQpIHtcbiAgICAgIHRleHQgPSBhd2FpdCBkcml2ZXIuZXhlY3V0ZUF0b20oJ2dldF9hdHRyaWJ1dGVfdmFsdWUnLCBbYXRvbXNFbGVtZW50LCAndmFsdWUnXSk7XG4gICAgfVxuXG4gICAgaWYgKHRleHQpIHtcbiAgICAgIGNvbnN0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCB0ZXh0LCB0cnVlKTtcbiAgICAgIGlmIChlbHMubGVuZ3RoID09PSAxIHx8IGVscy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgY29uc3QgZWwgPSBlbHNbMF07XG4gICAgICAgIC8vIHVzZSB0YXAgYmVjYXVzZSBvbiBpT1MgMTEuMiBhbmQgYmVsb3cgYG5hdGl2ZUNsaWNrYCBjcmFzaGVzIFdEQVxuICAgICAgICBjb25zdCByZWN0ID0gYXdhaXQgZHJpdmVyLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHt1dGlsLnVud3JhcEVsZW1lbnQoZWwpfS9yZWN0YCwgJ0dFVCcpO1xuICAgICAgICBpZiAoZWxzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgIGNvbnN0IGVsMiA9IGVsc1sxXTtcbiAgICAgICAgICBjb25zdCByZWN0MiA9IGF3YWl0IGRyaXZlci5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dXRpbC51bndyYXBFbGVtZW50KGVsMil9L3JlY3RgLCAnR0VUJyk7XG5cbiAgICAgICAgICBpZiAoKHJlY3QueCAhPT0gcmVjdDIueCB8fCByZWN0LnkgIT09IHJlY3QyLnkpIHx8XG4gICAgICAgICAgKHJlY3Qud2lkdGggIT09IHJlY3QyLndpZHRoIHx8IHJlY3QuaGVpZ2h0ICE9PSByZWN0Mi5oZWlnaHQpKSB7XG4gICAgICAgICAgICAvLyBUaGVzZSAyIG5hdGl2ZSBlbGVtZW50cyBhcmUgbm90IHJlZmVycmluZyB0byB0aGUgc2FtZSB3ZWIgZWxlbWVudFxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb29yZHMgPSB7XG4gICAgICAgICAgeDogTWF0aC5yb3VuZChyZWN0LnggKyByZWN0LndpZHRoIC8gMiksXG4gICAgICAgICAgeTogTWF0aC5yb3VuZChyZWN0LnkgKyByZWN0LmhlaWdodCAvIDIpLFxuICAgICAgICB9O1xuICAgICAgICBhd2FpdCBkcml2ZXIuY2xpY2tDb29yZHMoY29vcmRzKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBhbnkgZmFpbHVyZSBzaG91bGQgZmFsbCB0aHJvdWdoIGFuZCB0cmlnZ2VyIHRoZSBtb3JlIGVsYWJvcmF0ZVxuICAgIC8vIG1ldGhvZCBvZiBjbGlja2luZ1xuICAgIGxvZy53YXJuKGBFcnJvciBhdHRlbXB0aW5nIHRvIGNsaWNrOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXh0ZW5zaW9ucy5uYXRpdmVXZWJUYXAgPSBhc3luYyBmdW5jdGlvbiBuYXRpdmVXZWJUYXAgKGVsKSB7XG4gIGNvbnN0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcblxuICAvLyBpZiBzdHJpY3QgbmF0aXZlIHRhcCwgZG8gbm90IHRyeSB0byBkbyBpdCB3aXRoIFdEQSBkaXJlY3RseVxuICBpZiAoIShhd2FpdCB0aGlzLnNldHRpbmdzLmdldFNldHRpbmdzKCkpLm5hdGl2ZVdlYlRhcFN0cmljdCAmJiBhd2FpdCB0YXBXZWJFbGVtZW50TmF0aXZlbHkodGhpcywgYXRvbXNFbGVtZW50KSkge1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cud2FybignVW5hYmxlIHRvIGRvIHNpbXBsZSBuYXRpdmUgd2ViIHRhcC4gQXR0ZW1wdGluZyB0byBjb252ZXJ0IGNvb3JkaW5hdGVzJyk7XG5cbiAgLy8gYGdldF90b3BfbGVmdF9jb29yZGluYXRlc2AgcmV0dXJucyB0aGUgd3JvbmcgdmFsdWUgc29tZXRpbWVzLFxuICAvLyB1bmxlc3Mgd2UgcHJlLWNhbGwgYm90aCBvZiB0aGVzZSBmdW5jdGlvbnMgYmVmb3JlIHRoZSBhY3R1YWwgY2FsbHNcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcblxuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfc2l6ZScsIFthdG9tc0VsZW1lbnRdKTtcbiAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgeCArPSB3aWR0aCAvIDI7XG4gIHkgKz0gaGVpZ2h0IC8gMjtcblxuICB0aGlzLmN1cldlYkNvb3JkcyA9IHt4LCB5fTtcbiAgYXdhaXQgdGhpcy5jbGlja1dlYkNvb3JkcygpO1xufTtcblxuZXh0ZW5zaW9ucy5jbGlja0Nvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uIGNsaWNrQ29vcmRzIChjb29yZHMpIHtcbiAgYXdhaXQgdGhpcy5wZXJmb3JtVG91Y2goW1xuICAgIHtcbiAgICAgIGFjdGlvbjogJ3RhcCcsXG4gICAgICBvcHRpb25zOiBjb29yZHMsXG4gICAgfSxcbiAgXSk7XG59O1xuXG5leHRlbnNpb25zLnRyYW5zbGF0ZVdlYkNvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uIHRyYW5zbGF0ZVdlYkNvb3JkcyAoY29vcmRzKSB7XG4gIGxvZy5kZWJ1ZyhgVHJhbnNsYXRpbmcgY29vcmRpbmF0ZXMgKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0pIHRvIHdlYiBjb29yZGluYXRlc2ApO1xuXG4gIC8vIGFic29sdXRpemUgd2ViIGNvb3Jkc1xuICBsZXQgd2VidmlldyA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwoNSwgMTAwLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgd2Vidmlld3MgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVXZWJWaWV3JywgdHJ1ZSk7XG4gICAgaWYgKHdlYnZpZXdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyB3ZWJ2aWV3cyBmb3VuZC4gVW5hYmxlIHRvIHRyYW5zbGF0ZSB3ZWIgY29vcmRpbmF0ZXMgZm9yIG5hdGl2ZSB3ZWIgdGFwYCk7XG4gICAgfVxuICAgIHJldHVybiB3ZWJ2aWV3c1swXTtcbiAgfSk7XG4gIHdlYnZpZXcgPSB1dGlsLnVud3JhcEVsZW1lbnQod2Vidmlldyk7XG5cbiAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3dlYnZpZXd9L3JlY3RgLCAnR0VUJyk7XG4gIGNvbnN0IHd2UG9zID0ge3g6IHJlY3QueCwgeTogcmVjdC55fTtcbiAgY29uc3QgcmVhbERpbXMgPSB7dzogcmVjdC53aWR0aCwgaDogcmVjdC5oZWlnaHR9O1xuXG4gIGNvbnN0IGNtZCA9ICcoZnVuY3Rpb24gKCkgeyByZXR1cm4ge3c6IHdpbmRvdy5pbm5lcldpZHRoLCBoOiB3aW5kb3cuaW5uZXJIZWlnaHR9OyB9KSgpJztcbiAgY29uc3Qgd3ZEaW1zID0gYXdhaXQgdGhpcy5yZW1vdGUuZXhlY3V0ZShjbWQpO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzE0OTg4XG4gIGNvbnN0IGltcGxpY2l0V2FpdE1zID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgYXdhaXQgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCh3dlBvcywgcmVhbERpbXMpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuc2V0SW1wbGljaXRXYWl0KGltcGxpY2l0V2FpdE1zKTtcbiAgfVxuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyBNYXRoLnJvdW5kKHlSYXRpbyAqIGNvb3Jkcy55KSxcbiAgICB9O1xuXG4gICAgLy8gYWRkaXRpb25hbCBsb2dnaW5nIGZvciBjb29yZGluYXRlcywgc2luY2UgaXQgaXMgc29tZXRpbWVzIGJyb2tlblxuICAgIC8vICAgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy85MTU5XG4gICAgbG9nLmRlYnVnKGBDb252ZXJ0ZWQgY29vcmRpbmF0ZXM6ICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWN0OiAke0pTT04uc3RyaW5naWZ5KHJlY3QpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHd2UG9zOiAke0pTT04uc3RyaW5naWZ5KHd2UG9zKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWFsRGltczogJHtKU09OLnN0cmluZ2lmeShyZWFsRGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgd3ZEaW1zOiAke0pTT04uc3RyaW5naWZ5KHd2RGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeFJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHhSYXRpbyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeVJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHlSYXRpbyl9YCk7XG5cbiAgICBsb2cuZGVidWcoYENvbnZlcnRlZCB3ZWIgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0gYCArXG4gICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5leHRlbnNpb25zLmNoZWNrRm9yQWxlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0ZvckFsZXJ0ICgpIHtcbiAgcmV0dXJuIF8uaXNTdHJpbmcoYXdhaXQgdGhpcy5nZXRBbGVydFRleHQoKSk7XG59O1xuXG5leHRlbnNpb25zLndhaXRGb3JBdG9tID0gYXN5bmMgZnVuY3Rpb24gd2FpdEZvckF0b20gKHByb21pc2UpIHtcbiAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcblxuICAvLyBuZWVkIHRvIGNoZWNrIGZvciBhbGVydCB3aGlsZSB0aGUgYXRvbSBpcyBiZWluZyBleGVjdXRlZC5cbiAgLy8gc28gbm90aWZ5IG91cnNlbHZlcyB3aGVuIGl0IGhhcHBlbnNcbiAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgbGV0IGVycm9yID0gbnVsbDtcbiAgcHJvbWlzZSA9IEIucmVzb2x2ZShwcm9taXNlKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvY2F0Y2gtb3ItcmV0dXJuXG4gICAgLnRpbWVvdXQoQVRPTV9XQUlUX1RJTUVPVVQpXG4gICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgcmVjZWl2ZWQgd2hpbGUgZXhlY3V0aW5nIGF0b206ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpIHtcbiAgICAgICAgZXJyID0gbmV3IEVycm9yKGBEaWQgbm90IGdldCBhbnkgcmVzcG9uc2UgZm9yIGF0b20gZXhlY3V0aW9uIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICB9XG4gICAgICAvLyBzYXZlIGFuZCBjaGVjayBsYXRlciwgb3IgYW4gVW5oYW5kbGVkIHJlamVjdGlvbiB3aWxsIGJlIHJlcG9ydGVkXG4gICAgICBlcnJvciA9IGVycjtcbiAgICB9KVxuICAgIC5maW5hbGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgIGRvbmUgPSB0cnVlO1xuICAgIH0pO1xuXG4gIC8vIHRyeSB0ZW4gdGltZXMgdG8gY2hlY2sgYWxlcnRcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgLy8gcGF1c2UsIG9yIHRoZSBhdG9tIHByb21pc2UgaXMgcmVzb2x2ZWRcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiBkb25lLCB7XG4gICAgICAgIHdhaXRNczogQVRPTV9XQUlUX0FMRVJUX1dBSVQsXG4gICAgICAgIGludGVydmFsTXM6IDAsIC8vIGp1c3QgZm9yIHRoZSBwYXVzZSBpbiBleGVjdXRpb25cbiAgICAgIH0pO1xuICAgICAgLy8gYGRvbmVgIGJlY2FtZSB0cnVlLCBzbyBhdG9tIHByb21pc2UgaXMgcmVzb2x2ZWRcbiAgICAgIGJyZWFrO1xuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gYGRvbmVgIG5ldmVyIGJlY2FtZSB0cnVlLCBzbyBtb3ZlIG9uIHRvIHRyeWluZyB0byBmaW5kIGFuIGFsZXJ0XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYW4gYWxlcnQsIG9yIHRoZSBhdG9tIHByb21pc2UgaXMgcmVzb2x2ZWRcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgQi5hbnkoW3RoaXMuY2hlY2tGb3JBbGVydCgpLCBwcm9taXNlXSk7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShyZXMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gbm8gYWxlcnQgZm91bmQsIHNvIHBhc3MgdGhyb3VnaFxuICAgICAgbG9nLmRlYnVnKGBObyBhbGVydCBmb3VuZDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvLyBhdCB0aGlzIHBvaW50LCBhbGwgdGhhdCBjYW4gYmUgZG9uZSBpcyB3YWl0IGZvciB0aGUgYXRvbSBwcm9taXNlIHRvIGJlXG4gIC8vIHJlc29sdmVkXG4gIGNvbnN0IHJlcyA9IGF3YWl0IHByb21pc2U7XG4gIGlmIChlcnJvcikge1xuICAgIHRocm93IGVycm9yO1xuICB9XG4gIHJldHVybiB0aGlzLnBhcnNlRXhlY3V0ZVJlc3BvbnNlKHJlcyk7XG59O1xuXG5leHRlbnNpb25zLm1vYmlsZVdlYk5hdiA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVdlYk5hdiAobmF2VHlwZSkge1xuICB0aGlzLnJlbW90ZS5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtgaGlzdG9yeS4ke25hdlR5cGV9KCk7YCwgbnVsbF0pO1xuICB9IGZpbmFsbHkge1xuICAgIHRoaXMucmVtb3RlLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgPSBmYWxzZTtcbiAgfVxufTtcblxuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvd2ViLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
