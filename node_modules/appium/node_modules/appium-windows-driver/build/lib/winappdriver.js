"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WinAppDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = require("child_process");

var _appiumSupport = require("appium-support");

var _portscanner = require("portscanner");

const DEFAULT_BASE = '/wd/hub';
const DEFAULT_HOST = '127.0.0.1';
const WAD_PORT_RANGE = [4724, 4824];
const STARTUP_TIMEOUT_MS = 10000;
const DEFAULT_CREATE_SESSION_TIMEOUT_MS = 20000;

const PORT_ALLOCATION_GUARD = _appiumSupport.util.getLockFileGuard(_path.default.resolve(_os.default.tmpdir(), 'wad_port_guard'), {
  timeout: 5,
  tryRecovery: true
});

class WADProxy extends _appiumBaseDriver.JWProxy {
  async proxyCommand(url, method, body = null) {
    if (this.didProcessExit) {
      throw new _appiumBaseDriver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to WinAppDriver server because ` + 'its process is not running (probably crashed). Check the Appium log for more details');
    }

    return await super.proxyCommand(url, method, body);
  }

}

class WADProcess {
  constructor(opts = {}) {
    this.base = opts.base;
    this.port = opts.port;
    this.proc = null;
  }

  get isRunning() {
    var _this$proc;

    return !!((_this$proc = this.proc) !== null && _this$proc !== void 0 && _this$proc.isRunning);
  }

  async start() {
    if (this.isRunning) {
      return;
    }

    if (!this.port) {
      await PORT_ALLOCATION_GUARD(async () => {
        const [startPort, endPort] = WAD_PORT_RANGE;

        try {
          this.port = await (0, _portscanner.findAPortNotInUse)(startPort, endPort);
        } catch (e) {
          _logger.default.errorAndThrow(`Could not find any free port in range ${startPort}..${endPort}. ` + `Please check your system firewall settings or set 'systemPort' capability ` + `to the desired port number`);
        }
      });
    }

    const args = [`${this.port}${this.base}`];
    this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
      encoding: 'ucs2'
    });
    this.proc.on('output', (stdout, stderr) => {
      const line = _lodash.default.trim(stderr || stdout);

      if (line) {
        _logger.default.debug(line);
      }
    });
    this.proc.on('exit', (code, signal) => {
      _logger.default.info(`WinAppDriver exited with code ${code}, signal ${signal}`);
    });

    _logger.default.info(`Spawning '${_installer.WAD_INSTALL_PATH}' with args: ${JSON.stringify(args)}`);

    await this.proc.start(0);
  }

  async stop() {
    if (this.isRunning) {
      try {
        await this.proc.stop();
      } catch (e) {
        _logger.default.warn(`WinAppDriver process with PID ${this.proc.pid} cannot be stopped. ` + `Original error: ${e.message}`);
      }
    }
  }

}

const RUNNING_PROCESS_IDS = [];
process.once('exit', () => {
  for (const pid of RUNNING_PROCESS_IDS) {
    const command = `taskkill.exe /PID ${pid}`;

    try {
      (0, _child_process.execSync)(command);
    } catch (e) {
      _logger.default.warn(`WinAppDriver process with PID ${pid} cannot be cleaned up. ` + `Original error: ${e.message}`);
    }
  }
});

class WinAppDriver {
  constructor(opts = {}) {
    this.proxyPort = opts.port;
    this.process = null;
    this.proxy = null;
  }

  async start(caps) {
    if (!(await (0, _installer.isWADInstalled)())) {
      throw new Error(`WinAppDriver binary could not be found at the expected path ` + `'${_installer.WAD_INSTALL_PATH}'. Make sure it is installed`);
    }

    if (!(await (0, _installer.isWADChecksumOk)())) {
      _logger.default.warn('WinAppDriver exists, but the checksum did not match. Was it replaced manually?');
    }

    this.process = new WADProcess({
      base: DEFAULT_BASE,
      port: this.proxyPort
    });
    await this.process.start();
    this.proxy = new WADProxy({
      server: DEFAULT_HOST,
      port: this.process.port
    });
    this.proxy.didProcessExit = false;
    this.process.proc.on('exit', () => {
      this.proxy.didProcessExit = true;
    });

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          await this.proxy.command('/status', 'GET');
          return true;
        } catch (err) {
          if (this.proxy.didProcessExit) {
            throw new Error(err.message);
          }

          return false;
        }
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 1000
      });
    } catch (e) {
      if (/Condition unmet/.test(e.message)) {
        throw new Error(`WinAppDriver server is not listening within ${STARTUP_TIMEOUT_MS}ms timeout. ` + `Make sure it could be started manually`);
      }

      throw e;
    }

    const pid = this.process.proc.pid;
    RUNNING_PROCESS_IDS.push(pid);
    this.process.proc.on('exit', () => void _lodash.default.pull(RUNNING_PROCESS_IDS, pid));
    await this._startSession(caps);
  }

  async _startSession(desiredCapabilities) {
    const {
      createSessionTimeout = DEFAULT_CREATE_SESSION_TIMEOUT_MS
    } = desiredCapabilities;

    _logger.default.debug(`Starting WinAppDriver session. Will timeout in '${createSessionTimeout}' ms.`);

    let retryIteration = 0;
    let lastError;

    const condFn = async () => {
      lastError = null;
      retryIteration++;

      try {
        await this.proxy.command('/session', 'POST', {
          desiredCapabilities
        });
        return true;
      } catch (error) {
        lastError = error;

        _logger.default.warn(`Could not start WinAppDriver session error = '${error.message}', attempt = '${retryIteration}' from '${this.createSessionRetry}'`);

        return false;
      }
    };

    try {
      await (0, _asyncbox.waitForCondition)(condFn, {
        waitMs: createSessionTimeout,
        intervalMs: 500
      });
    } catch (timeoutError) {
      _logger.default.debug(`timeoutError was ${timeoutError.message}`);

      if (lastError) {
        throw lastError;
      }

      throw new Error(`Could not start WinAppDriver session within ${createSessionTimeout} ms.`);
    }
  }

  async stop() {
    var _this$process, _this$proxy;

    if (!((_this$process = this.process) !== null && _this$process !== void 0 && _this$process.isRunning)) {
      return;
    }

    if ((_this$proxy = this.proxy) !== null && _this$proxy !== void 0 && _this$proxy.sessionId) {
      _logger.default.debug('Deleting WinAppDriver server session');

      try {
        var _this$proxy2;

        await this.proxy.command(`/session/${(_this$proxy2 = this.proxy) === null || _this$proxy2 === void 0 ? void 0 : _this$proxy2.sessionId}`, 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err.message}`);
      }
    }

    await this.process.stop();
  }

  async sendCommand(url, method, body) {
    return await this.proxy.command(url, method, body);
  }

}

exports.WinAppDriver = WinAppDriver;
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiREVGQVVMVF9CQVNFIiwiREVGQVVMVF9IT1NUIiwiV0FEX1BPUlRfUkFOR0UiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMiLCJQT1JUX0FMTE9DQVRJT05fR1VBUkQiLCJ1dGlsIiwiZ2V0TG9ja0ZpbGVHdWFyZCIsInBhdGgiLCJyZXNvbHZlIiwib3MiLCJ0bXBkaXIiLCJ0aW1lb3V0IiwidHJ5UmVjb3ZlcnkiLCJXQURQcm94eSIsIkpXUHJveHkiLCJwcm94eUNvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwiZGlkUHJvY2Vzc0V4aXQiLCJlcnJvcnMiLCJJbnZhbGlkQ29udGV4dEVycm9yIiwiV0FEUHJvY2VzcyIsImNvbnN0cnVjdG9yIiwib3B0cyIsImJhc2UiLCJwb3J0IiwicHJvYyIsImlzUnVubmluZyIsInN0YXJ0Iiwic3RhcnRQb3J0IiwiZW5kUG9ydCIsImUiLCJsb2ciLCJlcnJvckFuZFRocm93IiwiYXJncyIsIlN1YlByb2Nlc3MiLCJXQURfSU5TVEFMTF9QQVRIIiwiZW5jb2RpbmciLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsImxpbmUiLCJfIiwidHJpbSIsImRlYnVnIiwiY29kZSIsInNpZ25hbCIsImluZm8iLCJKU09OIiwic3RyaW5naWZ5Iiwic3RvcCIsIndhcm4iLCJwaWQiLCJtZXNzYWdlIiwiUlVOTklOR19QUk9DRVNTX0lEUyIsInByb2Nlc3MiLCJvbmNlIiwiY29tbWFuZCIsIldpbkFwcERyaXZlciIsInByb3h5UG9ydCIsInByb3h5IiwiY2FwcyIsIkVycm9yIiwic2VydmVyIiwiZXJyIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsInRlc3QiLCJwdXNoIiwicHVsbCIsIl9zdGFydFNlc3Npb24iLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwiY3JlYXRlU2Vzc2lvblRpbWVvdXQiLCJyZXRyeUl0ZXJhdGlvbiIsImxhc3RFcnJvciIsImNvbmRGbiIsImVycm9yIiwiY3JlYXRlU2Vzc2lvblJldHJ5IiwidGltZW91dEVycm9yIiwic2Vzc2lvbklkIiwic2VuZENvbW1hbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsWUFBWSxHQUFHLFNBQXJCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLFdBQXJCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLENBQUMsSUFBRCxFQUFPLElBQVAsQ0FBdkI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUEzQjtBQUNBLE1BQU1DLGlDQUFpQyxHQUFHLEtBQTFDOztBQUdBLE1BQU1DLHFCQUFxQixHQUFHQyxvQkFBS0MsZ0JBQUwsQ0FBc0JDLGNBQUtDLE9BQUwsQ0FBYUMsWUFBR0MsTUFBSCxFQUFiLEVBQTBCLGdCQUExQixDQUF0QixFQUFtRTtBQUMvRkMsRUFBQUEsT0FBTyxFQUFFLENBRHNGO0FBRS9GQyxFQUFBQSxXQUFXLEVBQUU7QUFGa0YsQ0FBbkUsQ0FBOUI7O0FBS0EsTUFBTUMsUUFBTixTQUF1QkMseUJBQXZCLENBQStCO0FBQ1gsUUFBWkMsWUFBWSxDQUFFQyxHQUFGLEVBQU9DLE1BQVAsRUFBZUMsSUFBSSxHQUFHLElBQXRCLEVBQTRCO0FBQzVDLFFBQUksS0FBS0MsY0FBVCxFQUF5QjtBQUN2QixZQUFNLElBQUlDLHlCQUFPQyxtQkFBWCxDQUNILElBQUdKLE1BQU8sSUFBR0QsR0FBSSxxREFBbEIsR0FDQSxzRkFGSSxDQUFOO0FBR0Q7O0FBQ0QsV0FBTyxNQUFNLE1BQU1ELFlBQU4sQ0FBbUJDLEdBQW5CLEVBQXdCQyxNQUF4QixFQUFnQ0MsSUFBaEMsQ0FBYjtBQUNEOztBQVI0Qjs7QUFXL0IsTUFBTUksVUFBTixDQUFpQjtBQUNmQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsU0FBS0MsSUFBTCxHQUFZ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QVksS0FBS0csS0FBakIsaURBQVksYUFBWW1CLFNBQVUsRUFBckQsRUFBd0QsUUFBeEQsQ0FBTjtBQUNELE9BRkQsQ0FFRSxPQUFPZixHQUFQLEVBQVk7QUFDWmhDLHdCQUFJbUIsSUFBSixDQUFVLDhEQUFELEdBQ04sY0FBYWEsR0FBRyxDQUFDWCxPQUFRLEVBRDVCO0FBRUQ7QUFDRjs7QUFFRCxVQUFNLEtBQUtFLE9BQUwsQ0FBYUwsSUFBYixFQUFOO0FBQ0Q7O0FBRWdCLFFBQVg4QixXQUFXLENBQUVqRSxHQUFGLEVBQU9DLE1BQVAsRUFBZUMsSUFBZixFQUFxQjtBQUNwQyxXQUFPLE1BQU0sS0FBSzJDLEtBQUwsQ0FBV0gsT0FBWCxDQUFtQjFDLEdBQW5CLEVBQXdCQyxNQUF4QixFQUFnQ0MsSUFBaEMsQ0FBYjtBQUNEOztBQXJIZ0I7OztlQXlISnlDLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgSldQcm94eSwgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBXQURfSU5TVEFMTF9QQVRILCBpc1dBRENoZWNrc3VtT2ssIGlzV0FESW5zdGFsbGVkIH0gZnJvbSAnLi9pbnN0YWxsZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZmluZEFQb3J0Tm90SW5Vc2UgfSBmcm9tICdwb3J0c2Nhbm5lcic7XG5cblxuY29uc3QgREVGQVVMVF9CQVNFID0gJy93ZC9odWInO1xuY29uc3QgREVGQVVMVF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBXQURfUE9SVF9SQU5HRSA9IFs0NzI0LCA0ODI0XTtcbmNvbnN0IFNUQVJUVVBfVElNRU9VVF9NUyA9IDEwMDAwO1xuY29uc3QgREVGQVVMVF9DUkVBVEVfU0VTU0lPTl9USU1FT1VUX01TID0gMjAwMDA7IC8vIHJldHJ5IHN0YXJ0IHNlc3Npb24gY3JlYXRpb24gZHVyaW5nIHRoZSB0aW1lb3V0IGluIG1pbGxpc2Vjb25kc1xuLy8gVGhlIGd1YXJkIGlzIG5lZWRlZCB0byBhdm9pZCBkeW5hbWljIHN5c3RlbSBwb3J0IGFsbG9jYXRpb24gY29uZmxpY3RzIGZvclxuLy8gcGFyYWxsZWwgZHJpdmVyIHNlc3Npb25zXG5jb25zdCBQT1JUX0FMTE9DQVRJT05fR1VBUkQgPSB1dGlsLmdldExvY2tGaWxlR3VhcmQocGF0aC5yZXNvbHZlKG9zLnRtcGRpcigpLCAnd2FkX3BvcnRfZ3VhcmQnKSwge1xuICB0aW1lb3V0OiA1LFxuICB0cnlSZWNvdmVyeTogdHJ1ZSxcbn0pO1xuXG5jbGFzcyBXQURQcm94eSBleHRlbmRzIEpXUHJveHkge1xuICBhc3luYyBwcm94eUNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGlmICh0aGlzLmRpZFByb2Nlc3NFeGl0KSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRDb250ZXh0RXJyb3IoXG4gICAgICAgIGAnJHttZXRob2R9ICR7dXJsfScgY2Fubm90IGJlIHByb3hpZWQgdG8gV2luQXBwRHJpdmVyIHNlcnZlciBiZWNhdXNlIGAgK1xuICAgICAgICAnaXRzIHByb2Nlc3MgaXMgbm90IHJ1bm5pbmcgKHByb2JhYmx5IGNyYXNoZWQpLiBDaGVjayB0aGUgQXBwaXVtIGxvZyBmb3IgbW9yZSBkZXRhaWxzJyk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG59XG5cbmNsYXNzIFdBRFByb2Nlc3Mge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgdGhpcy5iYXNlID0gb3B0cy5iYXNlO1xuICAgIHRoaXMucG9ydCA9IG9wdHMucG9ydDtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICB9XG5cbiAgZ2V0IGlzUnVubmluZyAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMucHJvYz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucG9ydCkge1xuICAgICAgYXdhaXQgUE9SVF9BTExPQ0FUSU9OX0dVQVJEKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgW3N0YXJ0UG9ydCwgZW5kUG9ydF0gPSBXQURfUE9SVF9SQU5HRTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLnBvcnQgPSBhd2FpdCBmaW5kQVBvcnROb3RJblVzZShzdGFydFBvcnQsIGVuZFBvcnQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coXG4gICAgICAgICAgICBgQ291bGQgbm90IGZpbmQgYW55IGZyZWUgcG9ydCBpbiByYW5nZSAke3N0YXJ0UG9ydH0uLiR7ZW5kUG9ydH0uIGAgK1xuICAgICAgICAgICAgYFBsZWFzZSBjaGVjayB5b3VyIHN5c3RlbSBmaXJld2FsbCBzZXR0aW5ncyBvciBzZXQgJ3N5c3RlbVBvcnQnIGNhcGFiaWxpdHkgYCArXG4gICAgICAgICAgICBgdG8gdGhlIGRlc2lyZWQgcG9ydCBudW1iZXJgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtgJHt0aGlzLnBvcnR9JHt0aGlzLmJhc2V9YF07XG4gICAgdGhpcy5wcm9jID0gbmV3IFN1YlByb2Nlc3MoV0FEX0lOU1RBTExfUEFUSCwgYXJncywge1xuICAgICAgZW5jb2Rpbmc6ICd1Y3MyJ1xuICAgIH0pO1xuICAgIHRoaXMucHJvYy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBjb25zdCBsaW5lID0gXy50cmltKHN0ZGVyciB8fCBzdGRvdXQpO1xuICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGxpbmUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZy5pbmZvKGBXaW5BcHBEcml2ZXIgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgbG9nLmluZm8oYFNwYXduaW5nICcke1dBRF9JTlNUQUxMX1BBVEh9JyB3aXRoIGFyZ3M6ICR7SlNPTi5zdHJpbmdpZnkoYXJncyl9YCk7XG4gICAgYXdhaXQgdGhpcy5wcm9jLnN0YXJ0KDApO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgaWYgKHRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgV2luQXBwRHJpdmVyIHByb2Nlc3Mgd2l0aCBQSUQgJHt0aGlzLnByb2MucGlkfSBjYW5ub3QgYmUgc3RvcHBlZC4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY29uc3QgUlVOTklOR19QUk9DRVNTX0lEUyA9IFtdO1xucHJvY2Vzcy5vbmNlKCdleGl0JywgKCkgPT4ge1xuICBmb3IgKGNvbnN0IHBpZCBvZiBSVU5OSU5HX1BST0NFU1NfSURTKSB7XG4gICAgY29uc3QgY29tbWFuZCA9IGB0YXNra2lsbC5leGUgL1BJRCAke3BpZH1gO1xuICAgIHRyeSB7XG4gICAgICBleGVjU3luYyhjb21tYW5kKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgV2luQXBwRHJpdmVyIHByb2Nlc3Mgd2l0aCBQSUQgJHtwaWR9IGNhbm5vdCBiZSBjbGVhbmVkIHVwLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cbn0pO1xuXG5jbGFzcyBXaW5BcHBEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgdGhpcy5wcm94eVBvcnQgPSBvcHRzLnBvcnQ7XG5cbiAgICB0aGlzLnByb2Nlc3MgPSBudWxsO1xuICAgIHRoaXMucHJveHkgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKGNhcHMpIHtcbiAgICBpZiAoIWF3YWl0IGlzV0FESW5zdGFsbGVkKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgV2luQXBwRHJpdmVyIGJpbmFyeSBjb3VsZCBub3QgYmUgZm91bmQgYXQgdGhlIGV4cGVjdGVkIHBhdGggYCArXG4gICAgICAgIGAnJHtXQURfSU5TVEFMTF9QQVRIfScuIE1ha2Ugc3VyZSBpdCBpcyBpbnN0YWxsZWRgKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBpc1dBRENoZWNrc3VtT2soKSkge1xuICAgICAgbG9nLndhcm4oJ1dpbkFwcERyaXZlciBleGlzdHMsIGJ1dCB0aGUgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaC4gV2FzIGl0IHJlcGxhY2VkIG1hbnVhbGx5PycpO1xuICAgIH1cblxuICAgIHRoaXMucHJvY2VzcyA9IG5ldyBXQURQcm9jZXNzKHtcbiAgICAgIC8vIFhYWFlEIFRPRE86IHdvdWxkIGJlIGJldHRlciBpZiBXaW5BcHBEcml2ZXIgZGlkbid0IHJlcXVpcmUgcGFzc2luZyBpbiAvd2QvaHViIGFzIGEgcGFyYW1cbiAgICAgIGJhc2U6IERFRkFVTFRfQkFTRSxcbiAgICAgIHBvcnQ6IHRoaXMucHJveHlQb3J0LFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMucHJvY2Vzcy5zdGFydCgpO1xuXG4gICAgdGhpcy5wcm94eSA9IG5ldyBXQURQcm94eSh7XG4gICAgICBzZXJ2ZXI6IERFRkFVTFRfSE9TVCxcbiAgICAgIHBvcnQ6IHRoaXMucHJvY2Vzcy5wb3J0LFxuICAgIH0pO1xuICAgIHRoaXMucHJveHkuZGlkUHJvY2Vzc0V4aXQgPSBmYWxzZTtcbiAgICB0aGlzLnByb2Nlc3MucHJvYy5vbignZXhpdCcsICgpID0+IHtcbiAgICAgIHRoaXMucHJveHkuZGlkUHJvY2Vzc0V4aXQgPSB0cnVlO1xuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMucHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaWYgKHRoaXMucHJveHkuZGlkUHJvY2Vzc0V4aXQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IFNUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgICAgaW50ZXJ2YWxNczogMTAwMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICgvQ29uZGl0aW9uIHVubWV0Ly50ZXN0KGUubWVzc2FnZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBXaW5BcHBEcml2ZXIgc2VydmVyIGlzIG5vdCBsaXN0ZW5pbmcgd2l0aGluICR7U1RBUlRVUF9USU1FT1VUX01TfW1zIHRpbWVvdXQuIGAgK1xuICAgICAgICAgIGBNYWtlIHN1cmUgaXQgY291bGQgYmUgc3RhcnRlZCBtYW51YWxseWApO1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgY29uc3QgcGlkID0gdGhpcy5wcm9jZXNzLnByb2MucGlkO1xuICAgIFJVTk5JTkdfUFJPQ0VTU19JRFMucHVzaChwaWQpO1xuICAgIHRoaXMucHJvY2Vzcy5wcm9jLm9uKCdleGl0JywgKCkgPT4gdm9pZCBfLnB1bGwoUlVOTklOR19QUk9DRVNTX0lEUywgcGlkKSk7XG5cbiAgICBhd2FpdCB0aGlzLl9zdGFydFNlc3Npb24oY2Fwcyk7XG4gIH1cblxuICBhc3luYyBfc3RhcnRTZXNzaW9uIChkZXNpcmVkQ2FwYWJpbGl0aWVzKSB7XG4gICAgY29uc3Qge1xuICAgICAgY3JlYXRlU2Vzc2lvblRpbWVvdXQgPSBERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVNcbiAgICB9ID0gZGVzaXJlZENhcGFiaWxpdGllcztcbiAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIFdpbkFwcERyaXZlciBzZXNzaW9uLiBXaWxsIHRpbWVvdXQgaW4gJyR7Y3JlYXRlU2Vzc2lvblRpbWVvdXR9JyBtcy5gKTtcbiAgICBsZXQgcmV0cnlJdGVyYXRpb24gPSAwO1xuICAgIGxldCBsYXN0RXJyb3I7XG5cbiAgICBjb25zdCBjb25kRm4gPSBhc3luYyAoKSA9PiB7XG4gICAgICBsYXN0RXJyb3IgPSBudWxsO1xuICAgICAgcmV0cnlJdGVyYXRpb24rKztcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzfSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbGFzdEVycm9yID0gZXJyb3I7XG4gICAgICAgIGxvZy53YXJuKGBDb3VsZCBub3Qgc3RhcnQgV2luQXBwRHJpdmVyIHNlc3Npb24gZXJyb3IgPSAnJHtlcnJvci5tZXNzYWdlfScsIGF0dGVtcHQgPSAnJHtyZXRyeUl0ZXJhdGlvbn0nIGZyb20gJyR7dGhpcy5jcmVhdGVTZXNzaW9uUmV0cnl9J2ApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGNvbmRGbiwge1xuICAgICAgICB3YWl0TXM6IGNyZWF0ZVNlc3Npb25UaW1lb3V0LFxuICAgICAgICBpbnRlcnZhbE1zOiA1MDBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKHRpbWVvdXRFcnJvcikge1xuICAgICAgbG9nLmRlYnVnKGB0aW1lb3V0RXJyb3Igd2FzICR7dGltZW91dEVycm9yLm1lc3NhZ2V9YCk7XG4gICAgICBpZiAobGFzdEVycm9yKSB7XG4gICAgICAgIHRocm93IChsYXN0RXJyb3IpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc3RhcnQgV2luQXBwRHJpdmVyIHNlc3Npb24gd2l0aGluICR7Y3JlYXRlU2Vzc2lvblRpbWVvdXR9IG1zLmApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkge1xuICAgIGlmICghdGhpcy5wcm9jZXNzPy5pc1J1bm5pbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm94eT8uc2Vzc2lvbklkKSB7XG4gICAgICBsb2cuZGVidWcoJ0RlbGV0aW5nIFdpbkFwcERyaXZlciBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eS5jb21tYW5kKGAvc2Vzc2lvbi8ke3RoaXMucHJveHk/LnNlc3Npb25JZH1gLCAnREVMRVRFJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBXaW5BcHBEcml2ZXIgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5wcm9jZXNzLnN0b3AoKTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG59XG5cbmV4cG9ydCB7IFdpbkFwcERyaXZlciB9O1xuZXhwb3J0IGRlZmF1bHQgV2luQXBwRHJpdmVyO1xuIl0sImZpbGUiOiJsaWIvd2luYXBwZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
