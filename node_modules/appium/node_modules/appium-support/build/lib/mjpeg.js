"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.initMJpegServer = initMJpegServer;
exports.TEST_IMG_JPG = exports.MJpegStream = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _http = _interopRequireDefault(require("http"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _imageUtil = require("./image-util");

var _mjpegServer = _interopRequireDefault(require("mjpeg-server"));

var _stream = require("stream");

var _node = require("./node");

var _axios = _interopRequireDefault(require("axios"));

let MJpegConsumer = null;

async function initMJpegConsumer() {
  if (!MJpegConsumer) {
    try {
      MJpegConsumer = await (0, _node.requirePackage)('mjpeg-consumer');
    } catch (ign) {}
  }

  if (!MJpegConsumer) {
    throw new Error('mjpeg-consumer module is required to use MJPEG-over-HTTP features. ' + 'Please install it first (npm i -g mjpeg-consumer) and restart Appium.');
  }
}

const TEST_IMG_JPG = '/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAeAAD/4QOBaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjlDMzI3QkY0N0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjlDMzI3QkYzN0Q3NTExRThCMTlDOTVDMDc2RDE5MDY5IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE4IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NGY5ODc1OTctZGE2My00Y2M0LTkzNDMtNGYyNjgzMGUwNjk3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRmOTg3NTk3LWRhNjMtNGNjNC05MzQzLTRmMjY4MzBlMDY5NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv/uAA5BZG9iZQBkwAAAAAH/2wCEABALCwsMCxAMDBAXDw0PFxsUEBAUGx8XFxcXFx8eFxoaGhoXHh4jJSclIx4vLzMzLy9AQEBAQEBAQEBAQEBAQEABEQ8PERMRFRISFRQRFBEUGhQWFhQaJhoaHBoaJjAjHh4eHiMwKy4nJycuKzU1MDA1NUBAP0BAQEBAQEBAQEBAQP/AABEIACAAIAMBIgACEQEDEQH/xABgAAEAAwEAAAAAAAAAAAAAAAAABAUHCAEBAAAAAAAAAAAAAAAAAAAAABAAAQMCAgsAAAAAAAAAAAAAAAECBBEDEgYhMRODo7PTVAUWNhEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az8AAdAAAAAAI8+fE8dEuTZtzZR7VMb6OdTE5GJoYirrUp/e8qd9wb3TGe/lJ2551sx8D/9k=';
exports.TEST_IMG_JPG = TEST_IMG_JPG;
const MJPEG_SERVER_TIMEOUT_MS = 10000;

class MJpegStream extends _stream.Writable {
  constructor(mJpegUrl, errorHandler = _lodash.default.noop, options = {}) {
    super(options);
    this.errorHandler = errorHandler;
    this.url = mJpegUrl;
    this.clear();
  }

  get lastChunkBase64() {
    return !_lodash.default.isEmpty(this.lastChunk) && _lodash.default.isBuffer(this.lastChunk) ? this.lastChunk.toString('base64') : null;
  }

  async lastChunkPNG() {
    if (_lodash.default.isEmpty(this.lastChunk) || !_lodash.default.isBuffer(this.lastChunk)) {
      return null;
    }

    try {
      const jpg = await (0, _imageUtil.getJimpImage)(this.lastChunk);
      return await jpg.getBuffer(_imageUtil.MIME_PNG);
    } catch (e) {
      return null;
    }
  }

  async lastChunkPNGBase64() {
    const png = await this.lastChunkPNG();
    return png ? png.toString('base64') : null;
  }

  clear() {
    this.registerStartSuccess = null;
    this.registerStartFailure = null;
    this.responseStream = null;
    this.consumer = null;
    this.lastChunk = null;
    this.updateCount = 0;
  }

  async start(serverTimeout = MJPEG_SERVER_TIMEOUT_MS) {
    this.stop();
    await initMJpegConsumer();
    this.consumer = new MJpegConsumer();
    const startPromise = new _bluebird.default((res, rej) => {
      this.registerStartSuccess = res;
      this.registerStartFailure = rej;
    }).timeout(serverTimeout, `Waited ${serverTimeout}ms but the MJPEG server never sent any images`);
    const url = this.url;

    const onErr = err => {
      this.lastChunk = null;

      _logger.default.error(`Error getting MJpeg screenshot chunk: ${err.message}`);

      this.errorHandler(err);

      if (this.registerStartFailure) {
        this.registerStartFailure(err);
      }
    };

    const onClose = () => {
      _logger.default.debug(`The connection to MJPEG server at ${url} has been closed`);

      this.lastChunk = null;
    };

    try {
      this.responseStream = (await (0, _axios.default)({
        url,
        responseType: 'stream',
        timeout: serverTimeout
      })).data;
    } catch (e) {
      return onErr(e);
    }

    this.responseStream.once('close', onClose).on('error', onErr).pipe(this.consumer).pipe(this);
    await startPromise;
  }

  stop() {
    if (!this.consumer) {
      return;
    }

    this.responseStream.unpipe(this.consumer);
    this.consumer.unpipe(this);
    this.responseStream.destroy();
    this.clear();
  }

  write(data) {
    this.lastChunk = data;
    this.updateCount++;

    if (this.registerStartSuccess) {
      this.registerStartSuccess();
      this.registerStartSuccess = null;
    }
  }

}

exports.MJpegStream = MJpegStream;

function initMJpegServer(port, intMs = 300, times = 20) {
  const server = _http.default.createServer(async function (req, res) {
    const mJpegReqHandler = _mjpegServer.default.createReqHandler(req, res);

    const jpg = Buffer.from(TEST_IMG_JPG, 'base64');

    for (let i = 0; i < times; i++) {
      await _bluebird.default.delay(intMs);

      mJpegReqHandler._write(jpg, null, _lodash.default.noop);
    }

    mJpegReqHandler.close();
  }).listen(port);

  return server;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9tanBlZy5qcyJdLCJuYW1lcyI6WyJNSnBlZ0NvbnN1bWVyIiwiaW5pdE1KcGVnQ29uc3VtZXIiLCJpZ24iLCJFcnJvciIsIlRFU1RfSU1HX0pQRyIsIk1KUEVHX1NFUlZFUl9USU1FT1VUX01TIiwiTUpwZWdTdHJlYW0iLCJXcml0YWJsZSIsImNvbnN0cnVjdG9yIiwibUpwZWdVcmwiLCJlcnJvckhhbmRsZXIiLCJfIiwibm9vcCIsIm9wdGlvbnMiLCJ1cmwiLCJjbGVhciIsImxhc3RDaHVua0Jhc2U2NCIsImlzRW1wdHkiLCJsYXN0Q2h1bmsiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwibGFzdENodW5rUE5HIiwianBnIiwiZ2V0QnVmZmVyIiwiTUlNRV9QTkciLCJlIiwibGFzdENodW5rUE5HQmFzZTY0IiwicG5nIiwicmVnaXN0ZXJTdGFydFN1Y2Nlc3MiLCJyZWdpc3RlclN0YXJ0RmFpbHVyZSIsInJlc3BvbnNlU3RyZWFtIiwiY29uc3VtZXIiLCJ1cGRhdGVDb3VudCIsInN0YXJ0Iiwic2VydmVyVGltZW91dCIsInN0b3AiLCJzdGFydFByb21pc2UiLCJCIiwicmVzIiwicmVqIiwidGltZW91dCIsIm9uRXJyIiwiZXJyIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwib25DbG9zZSIsImRlYnVnIiwicmVzcG9uc2VUeXBlIiwiZGF0YSIsIm9uY2UiLCJvbiIsInBpcGUiLCJ1bnBpcGUiLCJkZXN0cm95Iiwid3JpdGUiLCJpbml0TUpwZWdTZXJ2ZXIiLCJwb3J0IiwiaW50TXMiLCJ0aW1lcyIsInNlcnZlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJtSnBlZ1JlcUhhbmRsZXIiLCJtSnBlZ1NlcnZlciIsImNyZWF0ZVJlcUhhbmRsZXIiLCJCdWZmZXIiLCJmcm9tIiwiaSIsImRlbGF5IiwiX3dyaXRlIiwiY2xvc2UiLCJsaXN0ZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztB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Sy9CLFNBQUwsR0FBaUIrQixJQUFqQjtBQUNBLFNBQUtqQixXQUFMOztBQUVBLFFBQUksS0FBS0osb0JBQVQsRUFBK0I7QUFDN0IsV0FBS0Esb0JBQUw7QUFDQSxXQUFLQSxvQkFBTCxHQUE0QixJQUE1QjtBQUNEO0FBQ0Y7O0FBN0pnQzs7OztBQXlLbkMsU0FBUzRCLGVBQVQsQ0FBMEJDLElBQTFCLEVBQWdDQyxLQUFLLEdBQUcsR0FBeEMsRUFBNkNDLEtBQUssR0FBRyxFQUFyRCxFQUF5RDtBQUN2RCxRQUFNQyxNQUFNLEdBQUdDLGNBQUtDLFlBQUwsQ0FBa0IsZ0JBQWdCQyxHQUFoQixFQUFxQnpCLEdBQXJCLEVBQTBCO0FBQ3pELFVBQU0wQixlQUFlLEdBQUdDLHFCQUFZQyxnQkFBWixDQUE2QkgsR0FBN0IsRUFBa0N6QixHQUFsQyxDQUF4Qjs7QUFDQSxVQUFNaEIsR0FBRyxHQUFHNkMsTUFBTSxDQUFDQyxJQUFQLENBQVloRSxZQUFaLEVBQTBCLFFBQTFCLENBQVo7O0FBR0EsU0FBSyxJQUFJaUUsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR1YsS0FBcEIsRUFBMkJVLENBQUMsRUFBNUIsRUFBZ0M7QUFDOUIsWUFBTWhDLGtCQUFFaUMsS0FBRixDQUFRWixLQUFSLENBQU47O0FBQ0FNLE1BQUFBLGVBQWUsQ0FBQ08sTUFBaEIsQ0FBdUJqRCxHQUF2QixFQUE0QixJQUE1QixFQUFrQ1gsZ0JBQUVDLElBQXBDO0FBQ0Q7O0FBQ0RvRCxJQUFBQSxlQUFlLENBQUNRLEtBQWhCO0FBQ0QsR0FWYyxFQVVaQyxNQVZZLENBVUxoQixJQVZLLENBQWY7O0FBWUEsU0FBT0csTUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBnZXRKaW1wSW1hZ2UsIE1JTUVfUE5HIH0gZnJvbSAnLi9pbWFnZS11dGlsJztcbmltcG9ydCBtSnBlZ1NlcnZlciBmcm9tICdtanBlZy1zZXJ2ZXInO1xuaW1wb3J0IHsgV3JpdGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgcmVxdWlyZVBhY2thZ2UgfSBmcm9tICcuL25vZGUnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcblxuXG4vLyBsYXp5IGxvYWQgdGhpcywgYXMgaXQgbWlnaHQgbm90IGJlIGF2YWlsYWJsZVxubGV0IE1KcGVnQ29uc3VtZXIgPSBudWxsO1xuXG4vKipcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBgbWpwZWctY29uc3VtZXJgIG1vZHVsZSBpcyBub3QgaW5zdGFsbGVkIG9yIGNhbm5vdCBiZSBsb2FkZWRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5pdE1KcGVnQ29uc3VtZXIgKCkge1xuICBpZiAoIU1KcGVnQ29uc3VtZXIpIHtcbiAgICB0cnkge1xuICAgICAgTUpwZWdDb25zdW1lciA9IGF3YWl0IHJlcXVpcmVQYWNrYWdlKCdtanBlZy1jb25zdW1lcicpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxuICBpZiAoIU1KcGVnQ29uc3VtZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ21qcGVnLWNvbnN1bWVyIG1vZHVsZSBpcyByZXF1aXJlZCB0byB1c2UgTUpQRUctb3Zlci1IVFRQIGZlYXR1cmVzLiAnICtcbiAgICAgICAgICAgICAgICAgICAgJ1BsZWFzZSBpbnN0YWxsIGl0IGZpcnN0IChucG0gaSAtZyBtanBlZy1jb25zdW1lcikgYW5kIHJlc3RhcnQgQXBwaXVtLicpO1xuICB9XG59XG5cbmNvbnN0IFRFU1RfSU1HX0pQRyA9ICcvOWovNFFBWVJYaHBaZ0FBU1VrcUFBZ0FBQUFBQUFBQUFBQUFBUC9zQUJGRWRXTnJlUUFCQUFRQUFBQWVBQUQvNFFPQmFIUjBjRG92TDI1ekxtRmtiMkpsTG1OdmJTOTRZWEF2TVM0d0x3QThQM2h3WVdOclpYUWdZbVZuYVc0OUl1Kzd2eUlnYVdROUlsYzFUVEJOY0VObGFHbEllbkpsVTNwT1ZHTjZhMk01WkNJL1BpQThlRHA0YlhCdFpYUmhJSGh0Ykc1ek9uZzlJbUZrYjJKbE9tNXpPbTFsZEdFdklpQjRPbmh0Y0hSclBTSkJaRzlpWlNCWVRWQWdRMjl5WlNBMUxqWXRZekUwTUNBM09TNHhOakEwTlRFc0lESXdNVGN2TURVdk1EWXRNREU2TURnNk1qRWdJQ0FnSUNBZ0lDSStJRHh5WkdZNlVrUkdJSGh0Ykc1ek9uSmtaajBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TVRrNU9TOHdNaTh5TWkxeVpHWXRjM2x1ZEdGNExXNXpJeUkrSUR4eVpHWTZSR1Z6WTNKcGNIUnBiMjRnY21SbU9tRmliM1YwUFNJaUlIaHRiRzV6T25odGNFMU5QU0pvZEhSd09pOHZibk11WVdSdlltVXVZMjl0TDNoaGNDOHhMakF2YlcwdklpQjRiV3h1Y3pwemRGSmxaajBpYUhSMGNEb3ZMMjV6TG1Ga2IySmxMbU52YlM5NFlYQXZNUzR3TDNOVWVYQmxMMUpsYzI5MWNtTmxVbVZtSXlJZ2VHMXNibk02ZUcxd1BTSm9kSFJ3T2k4dmJuTXVZV1J2WW1VdVkyOXRMM2hoY0M4eExqQXZJaUI0YlhCTlRUcFBjbWxuYVc1aGJFUnZZM1Z0Wlc1MFNVUTlJbmh0Y0M1a2FXUTZOR1k1T0RjMU9UY3RaR0UyTXkwMFkyTTBMVGt6TkRNdE5HWXlOamd6TUdVd05qazNJaUI0YlhCTlRUcEViMk4xYldWdWRFbEVQU0o0YlhBdVpHbGtPamxETXpJM1FrWTBOMFEzTlRFeFJUaENNVGxET1RWRE1EYzJSREU1TURZNUlpQjRiWEJOVFRwSmJuTjBZVzVqWlVsRVBTSjRiWEF1YVdsa09qbERNekkzUWtZek4wUTNOVEV4UlRoQ01UbERPVFZETURjMlJERTVNRFk1SWlCNGJYQTZRM0psWVhSdmNsUnZiMnc5SWtGa2IySmxJRkJvYjNSdmMyaHZjQ0JEUXlBeU1ERTRJQ2hOWVdOcGJuUnZjMmdwSWo0Z1BIaHRjRTFOT2tSbGNtbDJaV1JHY205dElITjBVbVZtT21sdWMzUmhibU5sU1VROUluaHRjQzVwYVdRNk5HWTVPRGMxT1RjdFpHRTJNeTAwWTJNMExUa3pORE10TkdZeU5qZ3pNR1V3TmprM0lpQnpkRkpsWmpwa2IyTjFiV1Z1ZEVsRVBTSjRiWEF1Wkdsa09qUm1PVGczTlRrM0xXUmhOak10TkdOak5DMDVNelF6TFRSbU1qWTRNekJsTURZNU55SXZQaUE4TDNKa1pqcEVaWE5qY21sd2RHbHZiajRnUEM5eVpHWTZVa1JHUGlBOEwzZzZlRzF3YldWMFlUNGdQRDk0Y0dGamEyVjBJR1Z1WkQwaWNpSS9Qdi91QUE1QlpHOWlaUUJrd0FBQUFBSC8yd0NFQUJBTEN3c01DeEFNREJBWER3MFBGeHNVRUJBVUd4OFhGeGNYRng4ZUZ4b2FHaG9YSGg0akpTY2xJeDR2THpNekx5OUFRRUJBUUVCQVFFQkFRRUJBUUVBQkVROFBFUk1SRlJJU0ZSUVJGQkVVR2hRV0ZoUWFKaG9hSEJvYUpqQWpIaDRlSGlNd0t5NG5KeWN1S3pVMU1EQTFOVUJBUDBCQVFFQkFRRUJBUUVCQVFQL0FBQkVJQUNBQUlBTUJJZ0FDRVFFREVRSC94QUJnQUFFQUF3RUFBQUFBQUFBQUFBQUFBQUFBQkFVSENBRUJBQUFBQUFBQUFBQUFBQUFBQUFBQUFCQUFBUU1DQWdzQUFBQUFBQUFBQUFBQUFBRUNCQkVERWdZaE1ST0RvN1BUVkFVV05oRUJBQUFBQUFBQUFBQUFBQUFBQUFBQUFQL2FBQXdEQVFBQ0VRTVJBRDhBejhBQWRBQUFBQUFJOCtmRThkRXVUWnR6WlI3Vk1iNk9kVEU1R0pvWWlyclVwL2U4cWQ5d2IzVEdlL2xKMjU1MXN4OEQvOWs9JztcblxuLy8gYW1vdW50IG9mIHRpbWUgdG8gd2FpdCBmb3IgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBzdHJlYW1cbmNvbnN0IE1KUEVHX1NFUlZFUl9USU1FT1VUX01TID0gMTAwMDA7XG5cbi8qKiBDbGFzcyB3aGljaCBzdG9yZXMgdGhlIGxhc3QgYml0IG9mIGRhdGEgc3RyZWFtZWQgaW50byBpdCAqL1xuY2xhc3MgTUpwZWdTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhbiBNSnBlZ1N0cmVhbVxuICAgKiBAcGFyYW0ge3N0cmluZ30gbUpwZWdVcmwgLSBVUkwgb2YgTUpQRUctb3Zlci1IVFRQIHN0cmVhbVxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbZXJyb3JIYW5kbGVyPW5vb3BdIC0gYWRkaXRpb25hbCBmdW5jdGlvbiB0aGF0IHdpbGwgYmVcbiAgICogY2FsbGVkIGluIHRoZSBjYXNlIG9mIGFueSBlcnJvcnMuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9ucz17fV0gLSBPcHRpb25zIHRvIHBhc3MgdG8gdGhlIFdyaXRhYmxlIGNvbnN0cnVjdG9yXG4gICAqL1xuICBjb25zdHJ1Y3RvciAobUpwZWdVcmwsIGVycm9ySGFuZGxlciA9IF8ubm9vcCwgb3B0aW9ucyA9IHt9KSB7XG4gICAgc3VwZXIob3B0aW9ucyk7XG5cbiAgICB0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLnVybCA9IG1KcGVnVXJsO1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGJhc2U2NC1lbmNvZGVkIHZlcnNpb24gb2YgdGhlIEpQRUdcbiAgICpcbiAgICogQHJldHVybnMgez9zdHJpbmd9IGJhc2U2NC1lbmNvZGVkIEpQRUcgaW1hZ2UgZGF0YVxuICAgKiBvciBgbnVsbGAgaWYgbm8gaW1hZ2UgY2FuIGJlIHBhcnNlZFxuICAgKi9cbiAgZ2V0IGxhc3RDaHVua0Jhc2U2NCAoKSB7XG4gICAgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5sYXN0Q2h1bmspICYmIF8uaXNCdWZmZXIodGhpcy5sYXN0Q2h1bmspXG4gICAgICA/IHRoaXMubGFzdENodW5rLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgUE5HIHZlcnNpb24gb2YgdGhlIEpQRUcgYnVmZmVyXG4gICAqXG4gICAqIEByZXR1cm5zIHs/QnVmZmVyfSBQTkcgaW1hZ2UgZGF0YSBvciBgbnVsbGAgaWYgbm8gUE5HXG4gICAqIGltYWdlIGNhbiBiZSBwYXJzZWRcbiAgICovXG4gIGFzeW5jIGxhc3RDaHVua1BORyAoKSB7XG4gICAgaWYgKF8uaXNFbXB0eSh0aGlzLmxhc3RDaHVuaykgfHwgIV8uaXNCdWZmZXIodGhpcy5sYXN0Q2h1bmspKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QganBnID0gYXdhaXQgZ2V0SmltcEltYWdlKHRoaXMubGFzdENodW5rKTtcbiAgICAgIHJldHVybiBhd2FpdCBqcGcuZ2V0QnVmZmVyKE1JTUVfUE5HKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBiYXNlNjQtZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSBQTkdcbiAgICpcbiAgICogQHJldHVybnMgez9zdHJpbmd9IGJhc2U2NC1lbmNvZGVkIFBORyBpbWFnZSBkYXRhXG4gICAqIG9yIGBudWxsYCBpZiBubyBpbWFnZSBjYW4gYmUgcGFyc2VkXG4gICAqL1xuICBhc3luYyBsYXN0Q2h1bmtQTkdCYXNlNjQgKCkge1xuICAgIGNvbnN0IHBuZyA9IGF3YWl0IHRoaXMubGFzdENodW5rUE5HKCk7XG4gICAgcmV0dXJuIHBuZyA/IHBuZy50b1N0cmluZygnYmFzZTY0JykgOiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IGludGVybmFsIHN0YXRlXG4gICAqL1xuICBjbGVhciAoKSB7XG4gICAgdGhpcy5yZWdpc3RlclN0YXJ0U3VjY2VzcyA9IG51bGw7XG4gICAgdGhpcy5yZWdpc3RlclN0YXJ0RmFpbHVyZSA9IG51bGw7XG4gICAgdGhpcy5yZXNwb25zZVN0cmVhbSA9IG51bGw7XG4gICAgdGhpcy5jb25zdW1lciA9IG51bGw7XG4gICAgdGhpcy5sYXN0Q2h1bmsgPSBudWxsO1xuICAgIHRoaXMudXBkYXRlQ291bnQgPSAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IHJlYWRpbmcgdGhlIE1KcGVnIHN0cmVhbSBhbmQgc3RvcmluZyB0aGUgbGFzdCBpbWFnZVxuICAgKi9cbiAgYXN5bmMgc3RhcnQgKHNlcnZlclRpbWVvdXQgPSBNSlBFR19TRVJWRVJfVElNRU9VVF9NUykge1xuICAgIC8vIGVuc3VyZSB3ZSdyZSBub3Qgc3RhcnRlZCBhbHJlYWR5XG4gICAgdGhpcy5zdG9wKCk7XG5cbiAgICBhd2FpdCBpbml0TUpwZWdDb25zdW1lcigpO1xuXG4gICAgdGhpcy5jb25zdW1lciA9IG5ldyBNSnBlZ0NvbnN1bWVyKCk7XG5cbiAgICAvLyB1c2UgdGhlIGRlZmVycmVkIHBhdHRlcm4gc28gd2UgY2FuIHdhaXQgZm9yIHRoZSBzdGFydCBvZiB0aGUgc3RyZWFtXG4gICAgLy8gYmFzZWQgb24gd2hhdCBjb21lcyBpbiBmcm9tIGFuIGV4dGVybmFsIHBpcGVcbiAgICBjb25zdCBzdGFydFByb21pc2UgPSBuZXcgQigocmVzLCByZWopID0+IHtcbiAgICAgIHRoaXMucmVnaXN0ZXJTdGFydFN1Y2Nlc3MgPSByZXM7XG4gICAgICB0aGlzLnJlZ2lzdGVyU3RhcnRGYWlsdXJlID0gcmVqO1xuICAgIH0pXG4gICAgLy8gc3RhcnQgYSB0aW1lb3V0IHNvIHRoYXQgaWYgdGhlIHNlcnZlciBkb2VzIG5vdCByZXR1cm4gZGF0YSwgd2UgZG9uJ3RcbiAgICAvLyBibG9jayBmb3JldmVyLlxuICAgICAgLnRpbWVvdXQoc2VydmVyVGltZW91dCxcbiAgICAgICAgYFdhaXRlZCAke3NlcnZlclRpbWVvdXR9bXMgYnV0IHRoZSBNSlBFRyBzZXJ2ZXIgbmV2ZXIgc2VudCBhbnkgaW1hZ2VzYCk7XG5cbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybDtcbiAgICBjb25zdCBvbkVyciA9IChlcnIpID0+IHtcbiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBnZXQgYW4gb3V0ZGF0ZWQgc2NyZWVuc2hvdCBpZiB0aGVyZSB3YXMgYW4gZXJyb3JcbiAgICAgIHRoaXMubGFzdENodW5rID0gbnVsbDtcblxuICAgICAgbG9nLmVycm9yKGBFcnJvciBnZXR0aW5nIE1KcGVnIHNjcmVlbnNob3QgY2h1bms6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB0aGlzLmVycm9ySGFuZGxlcihlcnIpO1xuICAgICAgaWYgKHRoaXMucmVnaXN0ZXJTdGFydEZhaWx1cmUpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN0YXJ0RmFpbHVyZShlcnIpO1xuICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgb25DbG9zZSA9ICgpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlIGNvbm5lY3Rpb24gdG8gTUpQRUcgc2VydmVyIGF0ICR7dXJsfSBoYXMgYmVlbiBjbG9zZWRgKTtcbiAgICAgIHRoaXMubGFzdENodW5rID0gbnVsbDtcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVzcG9uc2VTdHJlYW0gPSAoYXdhaXQgYXhpb3Moe1xuICAgICAgICB1cmwsXG4gICAgICAgIHJlc3BvbnNlVHlwZTogJ3N0cmVhbScsXG4gICAgICAgIHRpbWVvdXQ6IHNlcnZlclRpbWVvdXQsXG4gICAgICB9KSkuZGF0YTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gb25FcnIoZSk7XG4gICAgfVxuXG4gICAgdGhpcy5yZXNwb25zZVN0cmVhbVxuICAgICAgLm9uY2UoJ2Nsb3NlJywgb25DbG9zZSlcbiAgICAgIC5vbignZXJyb3InLCBvbkVycikgLy8gZW5zdXJlIHdlIGRvIHNvbWV0aGluZyB3aXRoIGVycm9yc1xuICAgICAgLnBpcGUodGhpcy5jb25zdW1lcikgLy8gYWxsb3cgY2h1bmtpbmcgYW5kIHRyYW5zZm9ybWluZyBvZiBqcGVnIGRhdGFcbiAgICAgIC5waXBlKHRoaXMpOyAvLyBzZW5kIHRoZSBhY3R1YWwganBlZ3MgdG8gb3Vyc2VsZlxuXG4gICAgYXdhaXQgc3RhcnRQcm9taXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgcmVhZGluZyB0aGUgTUpwZWcgc3RyZWFtLiBFbnN1cmUgd2UgZGlzY29ubmVjdCBhbGwgdGhlIHBpcGVzIGFuZCBzdG9wXG4gICAqIHRoZSBIVFRQIHJlcXVlc3QgaXRzZWxmLiBUaGVuIHJlc2V0IHRoZSBzdGF0ZS5cbiAgICovXG4gIHN0b3AgKCkge1xuICAgIGlmICghdGhpcy5jb25zdW1lcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucmVzcG9uc2VTdHJlYW0udW5waXBlKHRoaXMuY29uc3VtZXIpO1xuICAgIHRoaXMuY29uc3VtZXIudW5waXBlKHRoaXMpO1xuICAgIHRoaXMucmVzcG9uc2VTdHJlYW0uZGVzdHJveSgpO1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPdmVycmlkZSB0aGUgV3JpdGFibGUgd3JpdGUoKSBtZXRob2QgaW4gb3JkZXIgdG8gc2F2ZSB0aGUgbGFzdCBpbWFnZSBhbmRcbiAgICogbG9nIHRoZSBudW1iZXIgb2YgaW1hZ2VzIHdlIGhhdmUgcmVjZWl2ZWRcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwYXJhbSB7QnVmZmVyfSBkYXRhIC0gYmluYXJ5IGRhdGEgc3RyZWFtZWQgZnJvbSB0aGUgTUpwZWcgY29uc3VtZXJcbiAgICovXG4gIHdyaXRlIChkYXRhKSB7XG4gICAgdGhpcy5sYXN0Q2h1bmsgPSBkYXRhO1xuICAgIHRoaXMudXBkYXRlQ291bnQrKztcblxuICAgIGlmICh0aGlzLnJlZ2lzdGVyU3RhcnRTdWNjZXNzKSB7XG4gICAgICB0aGlzLnJlZ2lzdGVyU3RhcnRTdWNjZXNzKCk7XG4gICAgICB0aGlzLnJlZ2lzdGVyU3RhcnRTdWNjZXNzID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBTdGFydCBhbiBtanBlZyBzZXJ2ZXIgZm9yIHRoZSBwdXJwb3NlIG9mIHRlc3RpbmcsIHdoaWNoIGp1c3Qgc2VuZHMgdGhlIHNhbWVcbiAqIGltYWdlIG92ZXIgYW5kIG92ZXIuIENhbGxlciBpcyByZXNwb25zaWJsZSBmb3IgY2xvc2luZyB0aGUgc2VydmVyLlxuICogQHBhcmFtIHtpbnR9IHBvcnQgLSBwb3J0IHRoZSBzZXJ2ZXIgc2hvdWxkIGxpc3RlbiBvblxuICogQHBhcmFtIHtpbnR9IFtpbnRNc10gLSBob3cgb2Z0ZW4gdGhlIHNlcnZlciBzaG91bGQgcHVzaCBhbiBpbWFnZVxuICogQHBhcmFtIHtpbnR9IFt0aW1lc10gLSBob3cgbWFueSB0aW1lcyB0aGUgc2VydmVyIHNob3VsZCBwdXNoIGFuIGltYWdlIGJlZm9yZVxuICogaXQgY2xvc2VzIHRoZSBjb25uZWN0aW9uXG4gKiBAcmV0dXJucyB7aHR0cC5TZXJ2ZXJ9XG4gKi9cbmZ1bmN0aW9uIGluaXRNSnBlZ1NlcnZlciAocG9ydCwgaW50TXMgPSAzMDAsIHRpbWVzID0gMjApIHtcbiAgY29uc3Qgc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXN5bmMgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgbUpwZWdSZXFIYW5kbGVyID0gbUpwZWdTZXJ2ZXIuY3JlYXRlUmVxSGFuZGxlcihyZXEsIHJlcyk7XG4gICAgY29uc3QganBnID0gQnVmZmVyLmZyb20oVEVTVF9JTUdfSlBHLCAnYmFzZTY0Jyk7XG5cbiAgICAvLyBqdXN0IHNlbmQgdGhlIHNhbWUganBlZyBvdmVyIGFuZCBvdmVyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lczsgaSsrKSB7XG4gICAgICBhd2FpdCBCLmRlbGF5KGludE1zKTtcbiAgICAgIG1KcGVnUmVxSGFuZGxlci5fd3JpdGUoanBnLCBudWxsLCBfLm5vb3ApO1xuICAgIH1cbiAgICBtSnBlZ1JlcUhhbmRsZXIuY2xvc2UoKTtcbiAgfSkubGlzdGVuKHBvcnQpO1xuXG4gIHJldHVybiBzZXJ2ZXI7XG59XG5cbmV4cG9ydCB7IE1KcGVnU3RyZWFtLCBpbml0TUpwZWdTZXJ2ZXIsIFRFU1RfSU1HX0pQRyB9O1xuIl0sImZpbGUiOiJsaWIvbWpwZWcuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
